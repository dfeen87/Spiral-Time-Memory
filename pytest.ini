[pytest]
# Pytest configuration for spiral-time-memory

# Test discovery
testpaths = tests
python_files = test_*.py
python_classes = Test*
python_functions = test_*

# Output options
addopts = 
    # Verbosity
    -v
    --tb=short
    
    # Coverage
    --cov=theory
    --cov=analysis
    --cov=simulations
    --cov=experiments
    --cov-report=term-missing
    --cov-report=html:htmlcov
    --cov-report=xml
    
    # Parallel execution (use available CPU cores)
    -n auto
    
    # Warnings
    -W error::DeprecationWarning
    -W error::PendingDeprecationWarning
    
    # Disable cacheprovider for reproducibility
    -p no:cacheprovider
    
    # Show durations of slowest tests
    --durations=10
    
    # Markers
    --strict-markers
    
    # Fail on first error (uncomment for debugging)
    # -x
    
    # Show local variables in tracebacks (uncomment for debugging)
    # -l

# Markers for test categorization
markers =
    slow: marks tests as slow (deselect with '-m "not slow"')
    integration: marks tests as integration tests
    unit: marks tests as unit tests
    falsification: marks tests related to falsification criteria (Protocols A-C)
    discrimination: marks tests for Section 10 discrimination criteria
    memory_kernel: marks tests for memory kernel implementations
    cp_divisibility: marks tests for CP-divisibility detection
    state_independence: marks tests for state-independence criterion (Criterion 1)
    rank_analysis: marks tests for process tensor rank analysis (Criterion 3)
    numerical: marks tests for numerical stability
    requires_qutip: marks tests requiring QuTiP library (optional dependency)
    environmental: marks tests for environmental model comparisons

# Minimum Python version
minversion = 3.9

# Test discovery patterns - exclude these directories
norecursedirs = 
    .git
    .github
    .pytest_cache
    __pycache__
    htmlcov
    dist
    build
    *.egg-info
    paper
    examples/.ipynb_checkpoints
    .tox
    .eggs
    venv
    env

# Doctest options (if using doctests in code)
doctest_optionflags = 
    NORMALIZE_WHITESPACE
    ELLIPSIS
    IGNORE_EXCEPTION_DETAIL

# Console output style
console_output_style = progress

# Logging
log_cli = false
log_cli_level = INFO
log_cli_format = %(asctime)s [%(levelname)8s] %(message)s
log_cli_date_format = %Y-%m-%d %H:%M:%S

# Timeout for individual tests (prevent hanging)
# Requires pytest-timeout: pip install pytest-timeout
# timeout = 300  # 5 minutes max per test

# ============================================================================
# Coverage Configuration
# ============================================================================

[coverage:run]
source = 
    theory
    analysis
    simulations
    experiments

omit =
    */tests/*
    */test_*.py
    */__pycache__/*
    */site-packages/*
    setup.py
    */__init__.py  # Don't require coverage of __init__ files

branch = true
parallel = true

[coverage:report]
precision = 2
show_missing = true
skip_covered = false
skip_empty = true

# Exclude lines from coverage
exclude_lines =
    # Have to re-enable the standard pragma
    pragma: no cover
    
    # Don't complain about missing debug-only code
    def __repr__
    def __str__
    
    # Don't complain if tests don't hit defensive assertion code
    raise AssertionError
    raise NotImplementedError
    raise ValueError
    raise TypeError
    
    # Don't complain if non-runnable code isn't run
    if __name__ == .__main__.:
    if TYPE_CHECKING:
    @abstractmethod
    @abstract
    
    # Don't complain about protocol stubs
    ...
    pass

# Fail if coverage below this threshold
fail_under = 75

[coverage:html]
directory = htmlcov
title = Spiral-Time Memory Test Coverage

[coverage:xml]
output = coverage.xml

# ============================================================================
# Test-specific settings
# ============================================================================

# Ignore warnings from dependencies
filterwarnings =
    ignore::DeprecationWarning:pkg_resources
    ignore::PendingDeprecationWarning:importlib
    # Add specific warnings to ignore here if needed
    # Example: ignore::UserWarning:matplotlib

# Environment variables for tests
# Can be accessed via os.getenv() in tests
env =
    TESTING=1
    SPIRAL_TIME_TEST_MODE=true

# ============================================================================
# Performance and resource limits
# ============================================================================

# Maximum memory per test worker (requires pytest-xdist)
# Prevents memory leaks from hanging CI/CD
# --maxfail=5  # Stop after 5 failures

# ============================================================================
# Custom test collection
# ============================================================================

# pytest --collect-only will show test hierarchy
# pytest -k "test_memory" will run only tests matching "test_memory"
# pytest -m "unit and not slow" will run unit tests that aren't slow
# pytest tests/test_dynamics.py::TestMemoryKernel::test_exponential_decay

# ============================================================================
# Examples of running tests
# ============================================================================

# All tests:
#   pytest
#   make test
#
# Fast tests only (skip slow):
#   pytest -m "not slow"
#   make test-fast
#
# With coverage report:
#   pytest --cov-report=html
#   make test-cov
#
# Specific module:
#   pytest tests/test_dynamics.py
#
# Specific test:
#   pytest tests/test_dynamics.py::TestMemoryKernel::test_exponential_decay
#
# Run in parallel:
#   pytest -n 4  # Use 4 cores
#
# Stop on first failure:
#   pytest -x
#
# Show local variables:
#   pytest -l
#
# Verbose output:
#   pytest -vv
#
# Run only discrimination tests:
#   pytest -m discrimination
#
# Run only falsification tests:
#   pytest -m falsification
